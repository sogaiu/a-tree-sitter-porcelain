#! /bin/sh

# shellcheck disable=SC2034
THIS_SCRIPT_DESC="Generate grammar source under src"

THIS_SCRIPT=$(readlink -f "$0")
THIS_SCRIPT_DIR=$(dirname "$THIS_SCRIPT")
THIS_SCRIPT_NAME=$(basename "$THIS_SCRIPT")

# shellcheck source=.common
. "$THIS_SCRIPT_DIR/.common"

########################################################################

cur_dir=$(pwd)

deprintf "%s: start\n" "$THIS_SCRIPT_NAME"

cd "$PARSER_PROJ_DIR" || exit 1

########################################################################

deprintf "* Looking for grammar.js.\n"

if [ -f grammar.js ]; then
  deprintf "* Found it.\n"
else
  eprintf "* Failed to find it.\n"
  eprintf "%s: abort\n" "$THIS_SCRIPT_NAME"
  exit 1
fi

abi=${ATSP_ABI:-$("$ATSP_UTIL"/atsp-abi)}

# XXX: tree-sitter creates src directory if necessary so
#      not necessary for this script to check for it?

cmd="$ATSP_TS_PATH generate --abi $abi --no-bindings"

deprintf "* Invoking:\n"
deprintf "    %s\n" "$cmd"

eval "$cmd"
result=$?

if [ 0 -ne "$result" ]; then
  eprintf "* Generating source failed: %s.\n" "$result"
  eprintf "%s: abort\n" "$THIS_SCRIPT_NAME"
  exit 1
fi

########################################################################

cd "$cur_dir" || exit 1

deprintf "%s: end\n" "$THIS_SCRIPT_NAME"
