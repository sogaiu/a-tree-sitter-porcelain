#! /bin/sh

# shellcheck disable=SC2034
THIS_SCRIPT_DESC="Generate grammar source under src"

THIS_SCRIPT=$(readlink -f "$0")
THIS_SCRIPT_DIR=$(dirname "$THIS_SCRIPT")

# shellcheck source=.common
. "${THIS_SCRIPT_DIR}/.common"

########################################################################

cur_dir=$(pwd)

deprintf "Working on generating parser source.\n"

cd "${PARSER_PROJ_DIR}" || exit 1

deprintf "\n"

if [ -f grammar.js ]; then
  deprintf "* Found grammar.js, generating src/parser.c and friends.\n"
else
  eprintf "* Failed to find grammar.js...exiting\n"
  exit 1;
fi

deprintf "* Invoking tree-sitter generate subcommand\n"

abi=${ATSP_ABI:-$("${ATSP_UTIL}"/atsp-abi)}

# XXX: tree-sitter creates src directory if necessary so
#      not necessary for this script to check for it?

${ATSP_TS_PATH} generate --abi "${abi}" --no-bindings

deprintf "\n"

cd "${cur_dir}" || exit 1

deprintf "Done\n"
