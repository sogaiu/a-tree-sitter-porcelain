#! /bin/sh

# shellcheck disable=SC2034
this_script_desc="Install grammar's shared object"

this_script=$(readlink -f "$0")
this_script_dir=$(dirname "$this_script")
this_script_name=$(basename "$this_script")

# shellcheck source=.common
. "$this_script_dir/.common"

dep_script="build-so"

########################################################################

cur_dir=$(pwd)

deprintf "%s: start\n" "$this_script_name"

cd "$PARSER_PROJ_DIR" || exit 1

########################################################################

# this section is all about prerequisites

do_dep=${ATSP_FORCE:-0}

so_name=$("$ATSP_UTIL"/so-name)
so_path="$BUILD_DIR_PATH"/"$so_name"

# decide whether to execute dependency script
if [ 1 -eq "$do_dep" ]; then
  deprintf "* Unconditionally executing %s.\n" "$dep_script"
else
  deprintf "* Looking for built shared object at:\n"
  deprintf "    %s\n" "$so_path"
    
  if [ -f "$so_path" ]; then
    deprintf "* Found.\n"
  else
    deprintf "* Failed to find.\n"
    do_dep=1
  fi
fi

# executing dependency script if necessary
if [ 1 -eq "$do_dep" ]; then
  deprintf "* Calling %s.\n" "$dep_script"

  "$this_script_dir"/"$dep_script"
  result=$?

  if [ 0 -eq "$result" ]; then
    deprintf "%s: resume\n" "$this_script_name"
  else
    eprintf "%s: abort\n" "$this_script_name"
    exit 1
  fi
fi

########################################################################

# the rest of the file is about actually carrying things out

deprintf "* Ensuring shared object install directory exists at:\n"

deprintf "    %s\n" "$SO_INSTALL_DIR"

mkdir -p "$SO_INSTALL_DIR"

#deprintf "* Copying shared object into place\n"

cmd="cp $so_path $SO_INSTALL_DIR"

#deprintf "  * so name: %s\n" "$so_name"
#deprintf "  *  source: %s\n" "$BUILD_DIR_PATH/"
#deprintf "  *    dest: %s\n" "$SO_INSTALL_DIR/"

deprintf "* Invoking:\n"
deprintf "    %s\n" "$cmd"

eval "$cmd"
result=$?

if [ 0 -ne "$result" ]; then
  eprintf "* Copying failed: %s.\n" "$result"
  deprintf "%s: abort\n" "$this_script_name"
  exit 1
fi

########################################################################

cd "$cur_dir" || exit 1

deprintf "%s: end\n" "$this_script_name"
