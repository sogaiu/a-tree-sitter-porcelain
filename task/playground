#! /bin/sh

# shellcheck disable=SC2034
THIS_SCRIPT_DESC="Start tree-sitter playground"

THIS_SCRIPT=$(readlink -f "$0")
THIS_SCRIPT_DIR=$(dirname "$THIS_SCRIPT")
THIS_SCRIPT_NAME=$(basename "$THIS_SCRIPT")

# shellcheck source=.common
. "${THIS_SCRIPT_DIR}/.common"

dep_script="build-wasm"

########################################################################

# XXX: should this be done in other scripts?  may be not

# this is here because it seems that to stop tree-sitter playground a
# user is likely to press control-c.  resuming after doesn't appear to
# happen otherwise.  that might lead to an incorrect current working
# directory.

trap cleanup INT

# XXX: perhaps this could be defined in .common though

cleanup () {
  eprintf "\nLikely trapped Control-C\n"
}

########################################################################

cur_dir=$(pwd)

deprintf "%s: start\n" "$THIS_SCRIPT_NAME"

cd "$PARSER_PROJ_DIR" || exit 1

########################################################################

# this section is all about prerequisites

do_dep=${ATSP_FORCE:-0}

parser_wasm=$("$ATSP_UTIL"/wasm-name)
parser_wasm_path=$PARSER_PROJ_DIR/$parser_wasm

# decide whether to execute dependency script
if [ 1 -eq "$do_dep" ]; then
  deprintf "* Unconditionally executing %s.\n" "$dep_script"
else
  deprintf "* Expecting parser wasm at:\n"
  deprintf "    %s\n" "$parser_wasm_path"

  if [ -f "$parser_wasm_path" ]; then
    deprintf "* Found it.\n"
  else
    deprintf "* Failed to find it.\n"
    do_dep=1
  fi
fi

# executing dependency script if necessary
if [ 1 -eq "$do_dep" ]; then
  deprintf "* Calling %s.\n" "$dep_script"

  "$THIS_SCRIPT_DIR"/build-wasm
  result=$?

  if [ 0 -eq "$result" ]; then
    deprintf "%s: resume\n" "$THIS_SCRIPT_NAME"
  else
    eprintf "%s: abort\n" "$THIS_SCRIPT_NAME"
    exit 1
  fi
fi

cmd="$ATSP_TS_PATH playground"

deprintf "* Invoking:\n"
deprintf "    %s\n" "$cmd"

eval "$cmd"
result=$?

if [ 0 -ne "$result" ]; then
  eprintf "* Playground aborted: %s.\n" "$result"
  eprintf "%s: abort\n" "$THIS_SCRIPT_NAME"
  exit 1
fi

########################################################################

cd "$cur_dir" || exit 1

deprintf "%s: end\n" "$THIS_SCRIPT_NAME"

